<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Responsive Pendulum Lab</title>
    <style>
      :root {
        --accent: #00f2ff;
        --bg: #080809;
        --panel: rgba(15, 15, 17, 0.95);
      }

      body {
        margin: 0;
        font-family: "Inter", -apple-system, sans-serif;
        background: var(--bg);
        color: #999;
        overflow: hidden;
        display: flex;
        touch-action: none;
      }

      canvas {
        width: 100vw;
        height: 100vh;
        display: block;
        touch-action: none; /* Only the canvas handles physics touch */
      }

      .sidebar {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        width: 180px;
        background: var(--panel);
        backdrop-filter: blur(10px);
        border-left: 1px solid rgba(255, 255, 255, 0.05);
        padding: 15px;
        transform: translateX(0);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
        touch-action: pan-y; /* Allows scrolling inside menu if needed */
      }

      @media (max-width: 400px) {
        .sidebar {
          width: 140px;
          padding: 10px;
        }
        .tab-btn {
          font-size: 7px !important;
        }
      }

      .sidebar.hidden {
        transform: translateX(100%);
      }

      .toggle-btn {
        position: absolute;
        left: -36px;
        top: 15px;
        width: 36px;
        height: 36px;
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-right: none;
        border-radius: 8px 0 0 8px;
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 15px;
        border-bottom: 1px solid #222;
        padding-bottom: 8px;
      }
      .tab-btn {
        background: none;
        border: none;
        color: #555;
        font-size: 8px;
        cursor: pointer;
        text-transform: uppercase;
        padding: 4px 0;
        flex: 1;
      }
      .tab-btn.active {
        color: var(--accent);
        border-bottom: 1px solid var(--accent);
      }

      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .control-group {
        margin-bottom: 12px;
      }
      .label-row {
        display: flex;
        justify-content: space-between;
        font-size: 9px;
        margin-bottom: 4px;
      }
      .val {
        color: var(--accent);
        font-family: monospace;
      }

      input[type="range"],
      select,
      input[type="color"] {
        width: 100%;
        height: 2px;
        appearance: none;
        background: #222;
        outline: none;
        border: none;
      }
      input[type="color"] {
        height: 20px;
        background: none;
        cursor: pointer;
      }
      select {
        height: 20px;
        background: #111;
        border: 1px solid #333;
        color: #ccc;
        font-size: 9px;
        border-radius: 3px;
      }

      input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px; /* Larger for mobile thumbs */
        background: #ddd;
        border-radius: 50%;
        cursor: pointer;
      }

      .btn {
        width: 100%;
        background: #111;
        border: 1px solid #333;
        color: #eee;
        padding: 8px;
        font-size: 9px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>

    <div class="sidebar" id="sidebar">
      <button class="toggle-btn" onclick="toggleSidebar()">⚙</button>

      <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'physics')">
          Phys
        </button>
        <button class="tab-btn" onclick="openTab(event, 'style')">Style</button>
        <button class="tab-btn" onclick="openTab(event, 'colors')">
          Color
        </button>
      </div>

      <div id="physics" class="tab-content active">
        <div class="control-group">
          <div class="label-row">
            <span>Gravity</span> <span class="val" id="gVal">9.8</span>
          </div>
          <input type="range" id="g" min="1" max="25" step="0.1" value="9.8" />
        </div>
        <div class="control-group">
          <div class="label-row">
            <span>Length</span> <span class="val" id="lVal">1.5</span>
          </div>
          <input
            type="range"
            id="L"
            min="0.5"
            max="2.5"
            step="0.1"
            value="1.5"
          />
        </div>
        <div class="control-group">
          <div class="label-row">
            <span>Time Scale</span> <span class="val" id="tVal">1.0</span>
          </div>
          <input
            type="range"
            id="timeScale"
            min="0.1"
            max="3"
            step="0.1"
            value="1.0"
          />
        </div>
        <div class="control-group">
          <label class="label-row" style="cursor: pointer">
            <span>Show Grid</span>
            <input
              type="checkbox"
              id="gridToggle"
              checked
              style="width: auto; height: auto"
            />
          </label>
        </div>
        <button class="btn" onclick="omega = 6">Manual Kick</button>
      </div>

      <div id="style" class="tab-content">
        <div class="control-group">
          <div class="label-row"><span>Object Shape</span></div>
          <select id="shape">
            <option value="circle">Ball</option>
            <option value="square">Square</option>
            <option value="diamond">Diamond</option>
          </select>
        </div>
        <div class="control-group">
          <div class="label-row">
            <span>Object Size</span> <span class="val" id="sizeVal">8</span>
          </div>
          <input type="range" id="size" min="2" max="40" step="1" value="8" />
        </div>
      </div>

      <div id="colors" class="tab-content">
        <div class="control-group">
          <div class="label-row"><span>Background</span></div>
          <input type="color" id="bgColor" value="#080809" />
        </div>
        <div class="control-group">
          <div class="label-row"><span>Object</span></div>
          <input type="color" id="objColor" value="#00f2ff" />
        </div>
        <div class="control-group">
          <div class="label-row"><span>String</span></div>
          <input type="color" id="strColor" value="#333333" />
        </div>
        <div class="control-group">
          <div class="label-row"><span>Label Text</span></div>
          <input type="color" id="textColor" value="#ffffff" />
        </div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const sidebar = document.getElementById("sidebar");
      let W, H, dpr, pScale;

      const resize = () => {
        dpr = window.devicePixelRatio || 1;
        W = window.innerWidth;
        H = window.innerHeight;
        canvas.width = W * dpr;
        canvas.height = H * dpr;
        ctx.scale(dpr, dpr);
        pScale = Math.min(W, H) * 0.35;
      };
      window.onresize = resize;
      resize();

      let theta = Math.PI / 4,
        omega = 0,
        g = 9.8,
        L = 1.5,
        drag = 0.02;
      let bobSize = 8,
        bobShape = "circle",
        timeScale = 1.0;
      let bgColor = "#080809",
        objColor = "#00f2ff",
        textColor = "#ffffff",
        strColor = "#333333";
      let showGrid = true,
        dragging = false,
        history = [];
      const baseDt = 1 / 60;

      const toggleSidebar = () => sidebar.classList.toggle("hidden");

      // Prevent interaction with physics when clicking/dragging sidebar
      sidebar.addEventListener("mousedown", (e) => e.stopPropagation());
      sidebar.addEventListener("touchstart", (e) => e.stopPropagation(), {
        passive: true,
      });

      function openTab(evt, tabName) {
        let contents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < contents.length; i++)
          contents[i].classList.remove("active");
        let buttons = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < buttons.length; i++)
          buttons[i].classList.remove("active");
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
      }

      function getAccel(th, om) {
        return -(g / L) * Math.sin(th) - drag * om;
      }

      function stepRK4(dt) {
        const k1v = getAccel(theta, omega);
        const k1p = omega;
        const k2v = getAccel(theta + (k1p * dt) / 2, omega + (k1v * dt) / 2);
        const k2p = omega + (k1v * dt) / 2;
        const k3v = getAccel(theta + (k2p * dt) / 2, omega + (k2v * dt) / 2);
        const k3p = omega + (k2v * dt) / 2;
        const k4v = getAccel(theta + k3p * dt, omega + k3v * dt);
        const k4p = omega + k3v * dt;
        omega += (dt / 6) * (k1v + 2 * k2v + 2 * k3v + k4v);
        theta += (dt / 6) * (k1p + 2 * k2p + 2 * k3p + k4p);
      }

      function drawGrid() {
        if (!showGrid) return;
        ctx.strokeStyle = "rgba(255,255,255,0.03)";
        ctx.lineWidth = 1;
        for (let i = 0; i < W; i += 50) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, H);
          ctx.stroke();
        }
        for (let i = 0; i < H; i += 50) {
          ctx.beginPath();
          ctx.moveTo(0, i);
          ctx.lineTo(W, i);
          ctx.stroke();
        }
        ctx.strokeStyle = "rgba(255,255,255,0.1)";
        ctx.beginPath();
        ctx.moveTo(W / 2, 0);
        ctx.lineTo(W / 2, H);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, H * 0.2);
        ctx.lineTo(W, H * 0.2);
        ctx.stroke();
      }

      function drawBob(x, y) {
        ctx.fillStyle = objColor;
        ctx.shadowBlur = 15;
        ctx.shadowColor = objColor;
        ctx.beginPath();
        if (bobShape === "circle") ctx.arc(x, y, bobSize, 0, Math.PI * 2);
        else if (bobShape === "square")
          ctx.rect(x - bobSize, y - bobSize, bobSize * 2, bobSize * 2);
        else if (bobShape === "diamond") {
          ctx.moveTo(x, y - bobSize * 1.4);
          ctx.lineTo(x + bobSize * 1.4, y);
          ctx.lineTo(x, y + bobSize * 1.4);
          ctx.lineTo(x - bobSize * 1.4, y);
          ctx.closePath();
        }
        ctx.fill();
        ctx.shadowBlur = 0;

        let lt = 0;
        history.forEach((p, i) => {
          lt += p.t * Math.exp(-1.0 * (history.length - i) * baseDt) * baseDt;
        });

        ctx.font = "10px monospace";
        ctx.fillStyle = textColor;
        ctx.globalAlpha = 0.7;
        const labelX = x + bobSize + 10;
        const finalX = labelX + 60 > W ? x - bobSize - 70 : labelX;
        ctx.fillText(`ℒθ: ${lt.toFixed(3)}`, finalX, y);
        ctx.fillText(`θ: ${theta.toFixed(2)}`, finalX, y + 12);
        ctx.globalAlpha = 1.0;
      }

      function draw() {
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, W, H);
        drawGrid();
        if (!dragging) stepRK4(baseDt * timeScale);
        const ox = W / 2,
          oy = H * 0.2;
        const bx = ox + Math.sin(theta) * L * pScale;
        const by = oy + Math.cos(theta) * L * pScale;
        history.push({ t: theta });
        if (history.length > 40) history.shift();
        ctx.strokeStyle = strColor;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(ox, oy);
        ctx.lineTo(bx, by);
        ctx.stroke();
        drawBob(bx, by);
        requestAnimationFrame(draw);
      }

      const handleMove = (clientX, clientY) => {
        if (!dragging) return;
        theta = Math.atan2(clientX - W / 2, clientY - H * 0.2);
        omega = 0;
      };

      // Listeners restricted to Canvas for interaction
      canvas.addEventListener("mousedown", () => (dragging = true));
      window.addEventListener("mouseup", () => (dragging = false));
      window.addEventListener("mousemove", (e) =>
        handleMove(e.clientX, e.clientY)
      );

      canvas.addEventListener(
        "touchstart",
        (e) => {
          dragging = true;
          handleMove(e.touches[0].clientX, e.touches[0].clientY);
        },
        { passive: false }
      );
      window.addEventListener("touchend", () => (dragging = false));
      window.addEventListener(
        "touchmove",
        (e) => {
          if (dragging) {
            handleMove(e.touches[0].clientX, e.touches[0].clientY);
            e.preventDefault();
          }
        },
        { passive: false }
      );

      // Input Bindings
      document.getElementById("g").oninput = (e) => {
        g = +e.target.value;
        document.getElementById("gVal").textContent = g.toFixed(1);
      };
      document.getElementById("L").oninput = (e) => {
        L = +e.target.value;
        document.getElementById("lVal").textContent = L.toFixed(1);
      };
      document.getElementById("timeScale").oninput = (e) => {
        timeScale = +e.target.value;
        document.getElementById("tVal").textContent = timeScale.toFixed(1);
      };
      document.getElementById("gridToggle").onchange = (e) => {
        showGrid = e.target.checked;
      };
      document.getElementById("shape").onchange = (e) => {
        bobShape = e.target.value;
      };
      document.getElementById("size").oninput = (e) => {
        bobSize = +e.target.value;
        document.getElementById("sizeVal").textContent = bobSize;
      };
      document.getElementById("bgColor").oninput = (e) => {
        bgColor = e.target.value;
      };
      document.getElementById("objColor").oninput = (e) => {
        objColor = e.target.value;
      };
      document.getElementById("strColor").oninput = (e) => {
        strColor = e.target.value;
      };
      document.getElementById("textColor").oninput = (e) => {
        textColor = e.target.value;
      };

      draw();
    </script>
  </body>
</html>
